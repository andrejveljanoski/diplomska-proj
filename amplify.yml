version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install -g pnpm
        - pnpm install
        - echo "=== Environment Variables Check ==="
        - echo "DATABASE_URL=${DATABASE_URL:0:20}..."
        - echo "NEXTAUTH_URL=$NEXTAUTH_URL"
        - echo "R2_ENDPOINT=$R2_ENDPOINT"
        - env | grep -i "DATABASE\|AUTH\|R2" | head -20 || echo "No matching env vars found"
        - echo "Capturing environment variables for runtime..."
        - node scripts/capture-env.js
    build:
      commands:
        - echo "Verifying captured environment variables..."
        - test -f .env.production && echo "✓ .env.production exists" || echo "✗ .env.production missing"
        - env | grep -E "DATABASE_URL|NEXTAUTH|R2_" || true
        - pnpm run build
        - echo "Copying .env.production to standalone output..."
        - cp .env.production .next/standalone/.env.production
        - ls -la .next/standalone/.env.production
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
